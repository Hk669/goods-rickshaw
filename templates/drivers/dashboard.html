<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Driver Dashboard</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAG3yJWxO2VrtILP7Y_6y9SAOg0Sd9bUHo&libraries=places"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h2>Driver Dashboard</h2>
    <div id="map"></div>

    <script>
        let map, marker;

        function initMap() {
            // Initialize the map centered at a default location
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 15
            });

            marker = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                title: 'Your Location',
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });

            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        marker.setPosition(pos);
                        map.setCenter(pos);

                        // Send AJAX request to update location
                        updateLocation(pos.lat, pos.lng);
                    },
                    () => {
                        handleLocationError(true, marker, map.getCenter());
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, marker, map.getCenter());
            }
        }

        function handleLocationError(browserHasGeolocation, marker, pos) {
            marker.setPosition(pos);
            alert(browserHasGeolocation ?
                  'Error: The Geolocation service failed.' :
                  'Error: Your browser doesn\'t support geolocation.');
        }

        function updateLocation(latitude, longitude) {
            const csrfToken = getCookie('csrftoken');  // Implement getCookie function
            fetch("{% url 'update_location' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status !== 'success') {
                    console.error('Location update failed:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize map on window load
        window.onload = initMap;
    </script>
</body>
</html>
